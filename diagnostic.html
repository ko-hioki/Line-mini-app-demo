<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFFè¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="styles.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .diagnostic-card {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-ok { border-left: 4px solid #28a745; }
        .status-error { border-left: 4px solid #dc3545; }
        .status-warning { border-left: 4px solid #ffc107; }
        .debug-info {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ”§ LIFFè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
        </header>

        <main class="main-content">
            <div class="card">
                <h2>LIFFè¨­å®šè¨ºæ–­</h2>
                <button id="runDiagnostic" class="btn btn-primary">è¨ºæ–­ã‚’å®Ÿè¡Œ</button>
            </div>

            <div id="diagnosticResults" class="card" style="display: none;">
                <h2>è¨ºæ–­çµæœ</h2>
                <div id="results"></div>
            </div>

            <div class="card">
                <h2>æ¨å¥¨è¨­å®š</h2>
                <div class="diagnostic-card">
                    <h3>LINE Developers Consoleè¨­å®š</h3>
                    <ul>
                        <li><strong>Endpoint URL:</strong> HTTPSå¿…é ˆï¼ˆä¾‹: https://your-domain.com/ï¼‰</li>
                        <li><strong>Scope:</strong> profile, openid, chat_message.write</li>
                        <li><strong>Size:</strong> Full</li>
                        <li><strong>Bot Link Feature:</strong> Aggressiveï¼ˆæ¨å¥¨ï¼‰</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h2>
                <div class="diagnostic-card">
                    <h3>400 Bad Request ã®ä¸€èˆ¬çš„ãªåŸå› </h3>
                    <ul>
                        <li>LIFF IDãŒç„¡åŠ¹ã¾ãŸã¯å­˜åœ¨ã—ãªã„</li>
                        <li>Endpoint URLãŒHTTPSã§ãªã„</li>
                        <li>Endpoint URLãŒè¨­å®šã¨ç•°ãªã‚‹</li>
                        <li>ãƒãƒ£ãƒ³ãƒãƒ«ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹</li>
                        <li>LIFFã‚¢ãƒ—ãƒªãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script src="env.js"></script>
    <script>
        const LIFF_ID = window.ENV?.LIFF_ID || 'YOUR_LIFF_ID';
        
        document.getElementById('runDiagnostic').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('results');
            const diagnosticResults = document.getElementById('diagnosticResults');
            
            diagnosticResults.style.display = 'block';
            resultsDiv.innerHTML = '<p>è¨ºæ–­ä¸­...</p>';
            
            let results = [];
            
            // åŸºæœ¬æƒ…å ±ãƒã‚§ãƒƒã‚¯
            results.push({
                title: 'LIFF ID',
                status: LIFF_ID !== 'YOUR_LIFF_ID' ? 'ok' : 'error',
                message: LIFF_ID !== 'YOUR_LIFF_ID' ? `è¨­å®šæ¸ˆã¿: ${LIFF_ID}` : 'æœªè¨­å®šï¼ˆYOUR_LIFF_IDã®ã¾ã¾ï¼‰'
            });
            
            // URL ãƒã‚§ãƒƒã‚¯
            const isHttps = window.location.protocol === 'https:';
            results.push({
                title: 'HTTPSé€šä¿¡',
                status: isHttps ? 'ok' : 'warning',
                message: isHttps ? 'HTTPSç’°å¢ƒã§ã™' : 'HTTPç’°å¢ƒï¼ˆLIFFã®ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™ï¼‰'
            });
            
            // User Agent ãƒã‚§ãƒƒã‚¯
            const userAgent = navigator.userAgent;
            const isLineApp = userAgent.includes('Line/');
            results.push({
                title: 'LINE ã‚¢ãƒ—ãƒª',
                status: isLineApp ? 'ok' : 'warning',
                message: isLineApp ? 'LINEã‚¢ãƒ—ãƒªå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™' : 'é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™'
            });
            
            // LIFF SDK ãƒã‚§ãƒƒã‚¯
            results.push({
                title: 'LIFF SDK',
                status: typeof liff !== 'undefined' ? 'ok' : 'error',
                message: typeof liff !== 'undefined' ? 'LIFF SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™' : 'LIFF SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'
            });
            
            // LIFFåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
            if (typeof liff !== 'undefined') {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    results.push({
                        title: 'LIFFåˆæœŸåŒ–',
                        status: 'ok',
                        message: 'åˆæœŸåŒ–æˆåŠŸ'
                    });
                    
                    // è©³ç´°æƒ…å ±å–å¾—
                    const liffInfo = {
                        os: liff.getOS(),
                        language: liff.getLanguage(),
                        version: liff.getVersion(),
                        lineVersion: liff.getLineVersion(),
                        isInClient: liff.isInClient(),
                        isLoggedIn: liff.isLoggedIn(),
                        accessToken: liff.getAccessToken() ? 'å–å¾—æ¸ˆã¿' : 'æœªå–å¾—'
                    };
                    
                    results.push({
                        title: 'LIFFç’°å¢ƒæƒ…å ±',
                        status: 'ok',
                        message: '',
                        debug: JSON.stringify(liffInfo, null, 2)
                    });
                    
                    // QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
                    const qrScanV2Available = typeof liff.scanCodeV2 === 'function';
                    const qrScanV1Available = typeof liff.scanCode === 'function';
                    let qrStatus = 'error';
                    let qrMessage = 'QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
                    
                    if (qrScanV2Available) {
                        qrStatus = 'ok';
                        qrMessage = 'QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ï¼ˆscanCodeV2ï¼‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™';
                    } else if (qrScanV1Available) {
                        qrStatus = 'warning';
                        qrMessage = 'QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ï¼ˆscanCodeï¼‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰';
                    }
                    
                    results.push({
                        title: 'QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½',
                        status: qrStatus,
                        message: qrMessage,
                        debug: `scanCodeV2: ${qrScanV2Available ? 'åˆ©ç”¨å¯èƒ½' : 'åˆ©ç”¨ä¸å¯'}\nscanCode: ${qrScanV1Available ? 'åˆ©ç”¨å¯èƒ½' : 'åˆ©ç”¨ä¸å¯'}`
                    });
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
                    const sendMessagesAvailable = typeof liff.sendMessages === 'function';
                    const isLoggedIn = liff.isLoggedIn();
                    const isInClient = liff.isInClient();
                    
                    let messageStatus = 'error';
                    let messageStatusMsg = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
                    
                    if (sendMessagesAvailable && isLoggedIn && isInClient) {
                        messageStatus = 'ok';
                        messageStatusMsg = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™';
                    } else if (sendMessagesAvailable) {
                        messageStatus = 'warning';
                        if (!isLoggedIn) {
                            messageStatusMsg = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«ã¯LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                        } else if (!isInClient) {
                            messageStatusMsg = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«ã¯LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™';
                        }
                    }
                    
                    results.push({
                        title: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½',
                        status: messageStatus,
                        message: messageStatusMsg,
                        debug: `sendMessages: ${sendMessagesAvailable ? 'åˆ©ç”¨å¯èƒ½' : 'åˆ©ç”¨ä¸å¯'}\nãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: ${isLoggedIn ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}\nLINEç’°å¢ƒ: ${isInClient ? 'LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶' : 'é€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶'}`
                    });
                    
                } catch (error) {
                    results.push({
                        title: 'LIFFåˆæœŸåŒ–',
                        status: 'error',
                        message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`,
                        debug: `ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code || 'N/A'}\nã‚¹ã‚¿ãƒƒã‚¯: ${error.stack || 'N/A'}`
                    });
                }
            }
            
            // çµæœè¡¨ç¤º
            let html = '';
            results.forEach(result => {
                html += `
                    <div class="diagnostic-card status-${result.status}">
                        <h3>${result.title}</h3>
                        <p>${result.message}</p>
                        ${result.debug ? `<div class="debug-info">${result.debug}</div>` : ''}
                    </div>
                `;
            });
            
            // ç’°å¢ƒæƒ…å ±ã‚’è¿½åŠ 
            html += `
                <div class="diagnostic-card">
                    <h3>ç’°å¢ƒæƒ…å ±</h3>
                    <div class="debug-info">URL: ${window.location.href}
User Agent: ${navigator.userAgent}
ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${window.location.protocol}
ãƒ›ã‚¹ãƒˆ: ${window.location.host}
ãƒ‘ã‚¹: ${window.location.pathname}</div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        });
    </script>
    
    <footer style="background: #f8f9fa; padding: 1rem; text-align: center; color: #666; font-size: 0.8rem; border-top: 1px solid #e1e8ed; margin-top: 2rem;">
        <p>&copy; 2025 LINE ãƒŸãƒ‹ã‚¢ãƒ—ãƒª ãƒ‡ãƒ¢ - è¨ºæ–­ãƒ„ãƒ¼ãƒ«</p>
        <div style="margin-top: 10px;">
            <a href="index.html" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                ğŸ  ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
            </a>
            <a href="dev.html" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.5rem 1rem; margin-left: 0.5rem;">
                ğŸ› ï¸ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰
            </a>
        </div>
    </footer>
</body>
</html>
